<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>å›³æ›¸è²¸å‡ºãƒ•ã‚©ãƒ¼ãƒ </title>
<style>
  body { font-family: sans-serif; margin: 16px; line-height: 1.6; }
  form { margin-bottom: 16px; }
  input, button {
    padding: 8px;
    font-size: 16px;
    margin-top: 4px;
  }
  button {
    cursor: pointer;
    background: #007BFF;
    border: none;
    color: white;
    border-radius: 4px;
  }
  button:hover {
    background: #0056b3;
  }
  table { 
    border-collapse: collapse; 
    width: 100%; 
    margin-top: 12px; 
    font-size: 14px; 
  }
  th, td { 
    border: 1px solid #ccc; 
    padding: 8px; 
    text-align: center; 
  }
  th { 
    background: #f0f0f0; 
  }

  /* ã‚¹ãƒãƒ›å¯¾å¿œ */
  @media (max-width: 600px) {
    table, thead, tbody, th, td, tr { 
      display: block; 
      width: 100%; 
    }
    thead { display: none; } /* é …ç›®è¦‹å‡ºã—ã¯æ¶ˆã™ */
    tr { 
      margin-bottom: 16px; 
      border: 1px solid #ccc; 
      border-radius: 6px; 
      padding: 8px; 
      background: #fafafa; 
    }
    td { 
      text-align: left; 
      padding: 6px 6px 6px 50%; 
      position: relative; 
      border: none; 
      border-bottom: 1px solid #eee; 
    }
    td:last-child { border-bottom: none; }
    td::before {
      position: absolute;
      top: 6px;
      left: 6px;
      width: 45%;
      white-space: nowrap;
      font-weight: bold;
      color: #333;
    }
    td:nth-of-type(1)::before { content: "å‡ºå¸­ç•ªå·"; }
    td:nth-of-type(2)::before { content: "æ°å"; }
    td:nth-of-type(3)::before { content: "æœ¬ã®ã‚¿ã‚¤ãƒˆãƒ«"; }
    td:nth-of-type(4)::before { content: "è²¸å‡ºæ—¥"; }
    td:nth-of-type(5)::before { content: "è¿”å´æ—¥"; }
    td:nth-of-type(6)::before { content: "è¿”å´æ¸ˆã¿"; }
    input[type="checkbox"] {
      transform: scale(1.3);
      margin-left: 4px;
    }
  }
</style>
</head>
<body>
  <h2>å›³æ›¸è²¸å‡ºãƒ•ã‚©ãƒ¼ãƒ </h2>
  <form id="lendForm">
    <label>å‡ºå¸­ç•ªå·(4æ¡):<br><input id="studentId" pattern="\d{4}" required style="width:100%;"></label><br><br>
    <label>æœ¬ã®ã‚¿ã‚¤ãƒˆãƒ«:<br><input id="bookTitle" required style="width:100%;"></label><br><br>
    <button type="submit">ç™»éŒ²</button>
  </form>

  <div id="message" style="margin-top:12px; font-weight:bold;"></div>
  <div id="returnNotice" style="margin-top:12px; font-weight:bold; color:green;"></div>

  <h3>ğŸ” å‡ºå¸­ç•ªå·ã§æ¤œç´¢</h3>
  <form id="searchIdForm">
    <label>å‡ºå¸­ç•ªå·(4æ¡):<br><input id="searchId" pattern="\d{4}" required style="width:100%;"></label><br><br>
    <button type="submit">æ¤œç´¢</button>
  </form>

  <div id="searchMessage" style="margin-top:8px; font-weight:bold; color:blue;"></div>

  <table id="searchResultId">
    <thead>
      <tr>
        <th>å‡ºå¸­ç•ªå·</th>
        <th>æ°å</th>
        <th>æœ¬ã®ã‚¿ã‚¤ãƒˆãƒ«</th>
        <th>è²¸å‡ºæ—¥</th>
        <th>è¿”å´æ—¥</th>
        <th>è¿”å´æ¸ˆã¿</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxr8cFw8oCrgI3lhjWgBcYPx2H0Q5mAXwKlxa6866fC2evOJ1V3ksi1_BvgqDP036DAIw/exec";

    function showReturnNotice() {
      const today = new Date();
      const returnDate = new Date(today);
      returnDate.setDate(returnDate.getDate() + 14);
      const yyyy = returnDate.getFullYear();
      const mm = String(returnDate.getMonth() + 1).padStart(2, '0');
      const dd = String(returnDate.getDate()).padStart(2, '0');
      document.getElementById('returnNotice').innerText = `ğŸ“˜ è¿”å´ã¯ ${yyyy}/${mm}/${dd} ã§ã™ã€‚`;
    }
    showReturnNotice();

    // ç™»éŒ²å‡¦ç†
    document.getElementById('lendForm').addEventListener('submit', function(e){
      e.preventDefault();
      document.getElementById('message').innerText = "é€ä¿¡ä¸­...";
      const params = new URLSearchParams();
      params.append('studentId', document.getElementById('studentId').value);
      params.append('bookTitle', document.getElementById('bookTitle').value);

      fetch(GAS_URL, { method: 'POST', body: params })
        .then(res => res.json())
        .then(j => {
          if (j.result === 'success') {
            document.getElementById('message').innerText = 'âœ… ç™»éŒ²ã—ã¾ã—ãŸï¼';
            document.getElementById('lendForm').reset();
            showReturnNotice();
          } else {
            document.getElementById('message').innerText = 'âŒ ã‚µãƒ¼ãƒã‚¨ãƒ©ãƒ¼: ' + (j.message || "");
          }
        }).catch(err => {
          console.error('fetch error:', err);
          document.getElementById('message').innerText = 'âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
        });
    });

    // æ¤œç´¢å‡¦ç†
    document.getElementById('searchIdForm').addEventListener('submit', function(e){
      e.preventDefault();
      const id = document.getElementById('searchId').value.trim();
      document.getElementById('searchMessage').innerText = "æ¤œç´¢ä¸­...";
      fetch(GAS_URL + "?action=searchById&id=" + encodeURIComponent(id))
        .then(res => res.json())
        .then(data => {
          const tbody = document.querySelector("#searchResultId tbody");
          tbody.innerHTML = "";
          if (data.result === "success") {
            if (data.records.length > 0) {
              data.records.forEach(r => {
                const tr = document.createElement("tr");
                const checked = r.returned ? "checked" : "";
                tr.innerHTML = `
                  <td>${r.studentId}</td>
                  <td>${r.name}</td>
                  <td>${r.bookTitle}</td>
                  <td>${r.lendDate}</td>
                  <td>${r.returnDate}</td>
                  <td><input type="checkbox" data-row="${r.rowIndex}" ${checked}></td>
                `;
                tbody.appendChild(tr);
              });
              // âœ… ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆ
              tbody.querySelectorAll("input[type=checkbox]").forEach(cb => {
                cb.addEventListener("change", function() {
                  const rowIndex = this.dataset.row;
                  const returned = this.checked;
                  fetch(GAS_URL, {
                    method: "POST",
                    body: new URLSearchParams({
                      action: "returnBook",
                      rowIndex: rowIndex,
                      returned: returned
                    })
                  })
                  .then(res => res.json())
                  .then(j => {
                    if (j.result === "success") {
                      document.getElementById('searchMessage').innerText = "ğŸ“˜ çŠ¶æ…‹ã‚’æ›´æ–°ã—ã¾ã—ãŸ";
                    } else {
                      document.getElementById('searchMessage').innerText = "âŒ æ›´æ–°å¤±æ•—: " + (j.message || "");
                    }
                  })
                  .catch(err => {
                    console.error(err);
                    document.getElementById('searchMessage').innerText = "âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼";
                  });
                });
              });
              document.getElementById('searchMessage').innerText = "âœ… æ¤œç´¢å®Œäº†";
            } else {
              document.getElementById('searchMessage').innerText = "âš ï¸ è©²å½“ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“";
            }
          } else {
            document.getElementById('searchMessage').innerText = "âŒ " + data.message;
          }
        })
        .catch(err => { 
          console.error(err); 
          document.getElementById('searchMessage').innerText = "âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼"; 
        });
    });
  </script>
</body>
</html>
